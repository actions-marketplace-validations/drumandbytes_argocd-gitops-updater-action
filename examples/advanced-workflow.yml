# Advanced workflow - With authentication, caching, and notifications

name: Update Versions (Advanced)

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday at 2 AM
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cache registry API responses for performance
      - name: Cache registry API responses
        uses: actions/cache@v4
        with:
          path: .registry_cache
          key: registry-cache-${{ hashFiles('.update-config.yaml') }}-${{ github.run_number }}
          restore-keys: |
            registry-cache-${{ hashFiles('.update-config.yaml') }}-
            registry-cache-

      - name: Update Helm charts and Docker images
        id: update
        uses: drumandbytes/argocd-gitops-updater-action@v1
        with:
          config-path: '.update-config.yaml'
          create-pr: true
          dry-run: ${{ github.event.inputs.dry-run || false }}

          # Docker Hub authentication (increases rate limit)
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

          # Slack notifications
          notification-method: slack
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Post summary to job
      - name: Post summary
        if: always()
        run: |
          echo "## Version Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changes detected:** ${{ steps.update.outputs.changes-detected }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.update.outputs.pr-url }}" != "" ]; then
            echo "**PR created:** ${{ steps.update.outputs.pr-url }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Update Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.update.outputs.update-report }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
